# Database Schema and Data Flow

## Overview

The Finnish Vocabulary Learning App uses Firebase Firestore as its database. The data is structured around global vocabulary data and user-specific learning progress.

## Collections and Entities

### 1. Global Collections (Read-Only for Users)

#### `vocabulary` Collection

Stores all vocabulary words available in the app.

**Document Structure:**

```json
{
  "id": "string", // Auto-generated document ID
  "finnish": "string", // Finnish word
  "english": "string", // English translation
  "partOfSpeech": "string?", // noun, verb, adjective, etc.
  "categories": ["string"], // Array of category IDs
  "cefr": "string?", // CEFR level
  "pronunciation": "string?", // Phonetic pronunciation
  "audio": "string?", // Audio file URL
  "examples": ["string"], // Example sentences
  "difficultyScore": "number?", // Difficulty rating
  "frequency": "number?", // Word frequency in language
  "example": "string?", // Single example sentence
  "aiGenerated": "boolean?", // Whether generated by AI
  "generatedAt": "string?", // ISO timestamp
  "aiService": "string?", // AI service used
  "categoryId": "string?", // Primary category ID
  "difficulty": "beginner|intermediate|advanced", // Difficulty level
  "fallbackUsed": "boolean?" // Whether fallback was used
}
```

#### `categories` Collection

Stores category definitions for grouping words.

**Document Structure:**

```json
{
  "id": "string", // Auto-generated document ID
  "name": "string", // Category name (e.g., "Family & People")
  "count": "number", // Number of words in category
  "emoji": "string", // Category emoji
  "description": "string?" // Optional description
}
```

### 2. User-Specific Collections

#### `users` Collection

Stores user account data and preferences.

**Document Structure:**

```json
{
  "folders": [
    {
      "id": "string", // Folder ID
      "name": "string", // Folder name
      "wordIds": ["string"] // Array of word IDs in folder
    }
  ],
  "favorites": ["string"] // Array of favorite word IDs
}
```

#### `users/{userId}/srsWords` Subcollection

Stores Spaced Repetition System (SRS) data for each word per user.

**Document Structure:**

```json
{
  "interval": "number", // Current interval in days
  "repetitions": "number", // Streak of correct answers
  "easinessFactor": "number", // Multiplier (starts at 2.5)
  "nextReviewDate": "string" // ISO date string (e.g., "2025-12-25")
}
```

## Entity Relationship Diagram

```
┌─────────────────┐       ┌─────────────────┐
│   Vocabulary    │       │    Category     │
│                 │       │                 │
│ - id            │       │ - id            │
│ - finnish       │       │ - name          │
│ - english       │       │ - count         │
│ - categories[]  │◄──────┤ - emoji         │
│ - difficulty    │       │ - description   │
│ - ...           │       └─────────────────┘
└─────────────────┘
         │
         │ 1:N (belongs to)
         ▼
┌─────────────────┐       ┌─────────────────┐
│      User       │       │   SRS Word      │
│                 │       │                 │
│ - folders[]     │       │ - interval      │
│ - favorites[]   │       │ - repetitions   │
│                 │       │ - easinessFactor│
└─────────────────┘       │ - nextReviewDate│
         │                └─────────────────┘
         │
         │ 1:N (contains)
         ▼
┌─────────────────┐
│   User Folder   │
│                 │
│ - id            │
│ - name          │
│ - wordIds[]     │
└─────────────────┘
```

## Data Flow

### 1. Initial Load

- App loads → Authenticate user → Fetch global vocabulary & categories
- Load user data (folders, favorites) from `users/{userId}`

### 2. Review Session

- Calculate due words: Filter vocabulary where `nextReviewDate` ≤ current date
- Select session words: Prioritize hard words + new words (up to 20)
- User grades word → Update SRS data in `users/{userId}/srsWords/{wordId}`
- Save review history in localStorage for session adaptation

### 3. Vocabulary Browsing

- Filter words by category/difficulty from global collections
- User can add words to folders or favorites (stored in user document)

### 4. Data Synchronization

- Vocabulary data cached in localStorage (24h expiry)
- User data synced with Firestore on changes
- SRS updates trigger refresh of vocabulary data to get latest review dates

## Key Relationships

- **Vocabulary ↔ Category**: Many-to-many via `categories` array
- **User ↔ Vocabulary**: Many-to-many via folders and favorites
- **User ↔ SRS Word**: One-to-one per word (SRS progress tracking)
- **User ↔ Folder**: One-to-many (user owns folders containing words)

## Indexes and Queries

### Required Firestore Indexes

- `vocabulary` collection: `frequency` (desc), `categories` (array-contains)
- `vocabulary` collection: `difficulty` (==)
- `categories` collection: No special indexes needed

### Common Queries

- Get all vocabulary: `orderBy('frequency', 'desc').limit(5000)`
- Get words by category: `where('categories', 'array-contains', categoryId)`
- Get words by difficulty: `where('difficulty', '==', difficulty)`
- Get user data: `doc('users', userId)`
- Get SRS data: `doc('users', userId, 'srsWords', wordId)`
